<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†Ø¨Øª | Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root {
    --bg: #f6faf7;
    --card: #ffffff;
    --text: #1f2937;
    --green: #2F7D32;
}

body.dark {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #e5e7eb;
}

body {
    font-family: Tahoma, Arial;
    direction: rtl;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 15px;
}

.toggle {
    position: fixed;
    top: 15px;
    left: 15px;
    background: var(--card);
    padding: 8px 12px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    z-index: 1000;
}

.container {
    max-width: 900px;
    margin: auto;
}

.card {
    background: var(--card);
    padding: 16px;
    border-radius: 16px;
    margin-bottom: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
}

.card h3 {
    margin: 0 0 8px 0;
}

/* â­ Ø§Ù„Ù…Ù‡Ù… Ù‡Ù†Ø§ â­ */
.card input {
    height: 34px;          /* Ø£Ù‚ØµØ± Ø¨ÙˆØ¶ÙˆØ­ */
    padding: 0 10px;       /* Ø¨Ø¯ÙˆÙ† Ù†ÙØ® */
    font-size: 14px;
    line-height: 34px;     /* Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ */
    border-radius: 12px;
    border: 1px solid #ccc;
    margin-bottom: 6px;
    box-sizing: border-box;
}


/* input */
.card input {
    height: 38px;
    padding: 0 12px;       /* Ø¨Ø¯ÙˆÙ† Ø§Ø±ØªÙØ§Ø¹ Ø²Ø§Ø¦Ø¯ */
    border: 1px solid #ccc;
    margin-bottom: 6px;
}

/* button */
.card button {
    border: none;
    background: var(--green);
    color: white;
    cursor: pointer;
}

#map {
    height: 380px;
    border-radius: 16px;
}

.rank {
    display: flex;
    justify-content: space-between;
    background: rgba(47,125,50,0.12);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 6px;
}
</style>
</head>

<body>

<div class="toggle" onclick="toggleDark()">ğŸŒ™</div>

<div class="container">

<h2>ğŸŒ± Ù…Ù†Ø¨Øª</h2>
<p>Ø®Ø±ÙŠØ·Ø© ØªÙˆØ¶Ø­ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</p>

<div class="card">
    <b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª:</b>
    <span id="counter">...</span>
</div>

<div class="card">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±ÙƒØ©</h3>
    <input id="schoolName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
    <button onclick="submit()">Ø¥Ø¶Ø§ÙØ© ğŸŒ¿</button>
</div>

<div class="card">
    <h3>ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</h3>
    <div id="topList"></div>
</div>

<div id="map"></div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
function toggleDark() {
    document.body.classList.toggle("dark");
}

let deviceId = localStorage.getItem("device_id");
if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem("device_id", deviceId);
}

var map = L.map('map').setView([24.7, 46.7], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let selected = null;
map.on('click', e => selected = e.latlng);

fetch('/schools')
.then(r => r.json())
.then(data => {
    data.forEach(s => {
        L.marker([s.lat, s.lng])
            .addTo(map)
            .bindPopup(s.school + "<br>ğŸ‘©â€ğŸ“ " + s.count);
    });
});

fetch('/count')
.then(r => r.json())
.then(d => counter.innerText = d.count);

fetch('/schools/top')
.then(r => r.json())
.then(data => {
    topList.innerHTML = "";
    data.forEach(s => {
        let div = document.createElement("div");
        div.className = "rank";
        div.innerHTML = `<span>${s.school}</span><b>${s.count}</b>`;
        topList.appendChild(div);
    });
});

function submit() {
    let school = schoolName.value.trim();
    if (!school || !selected) {
        alert("Ø­Ø¯Ø¯ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©");
        return;
    }

    fetch('/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            school: school,
            lat: selected.lat,
            lng: selected.lng,
            device_id: deviceId
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) alert(d.error);
        else {
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© ğŸŒ±");
            location.reload();
        }
    });
}
</script>

</body>
</html>
