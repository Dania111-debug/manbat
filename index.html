<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†Ø¨Øª | Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
    font-family: Tahoma;
    direction: rtl;
    margin:0;
    padding:15px;
    transition:0.3s;
}

body.dark{
    background:#121212;
    color:white;
}

.container{
    max-width:900px;
    margin:auto;
}

.card{
    background:#f4f4f4;
    padding:15px;
    border-radius:15px;
    margin-bottom:10px;
    transition:0.3s;
}

body.dark .card{
    background:#1e1e1e;
}

.card input,
.card select,
.card button{
    width:100%;
    height:40px;
    margin-bottom:6px;
    border-radius:10px;
}

.card button{
    background:#2F7D32;
    color:white;
    border:none;
    cursor:pointer;
}

#map{
    height:50vh;
    max-height:400px;

}

#top5{
    font-size:14px;
    margin-bottom:10px;
}
</style>
</head>

<body>

<div class="container">

<button onclick="toggleMode()" id="modeBtn" style="float:left;">ğŸŒ™</button>

<h2>ğŸŒ± Ù…Ù†Ø¨Øª</h2>

<div id="top5"></div>

<div class="card">

<input id="schoolName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">

<select id="stage">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
<option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
<option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option>
</select>

<select id="gender">
<option value="">Ø¨Ù†ÙŠÙ† / Ø¨Ù†Ø§Øª</option>
<option value="Ø¨Ù†ÙŠÙ†">Ø¨Ù†ÙŠÙ†</option>
<option value="Ø¨Ù†Ø§Øª">Ø¨Ù†Ø§Øª</option>
</select>

<select id="region" onchange="updateCities()">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
<option value="Ø§Ù„ÙˆØ³Ø·Ù‰">Ø§Ù„ÙˆØ³Ø·Ù‰</option>
<option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
<option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
<option value="Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©">Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©</option>
<option value="Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©">Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©</option>
</select>

<select id="city">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
</select>

<button onclick="submitSchool()">Ø¥Ø¶Ø§ÙØ© ğŸŒ¿</button>

</div>

<div id="map"></div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAkDXP7hCcgdQ_PtInKHAsVvXzwOLW1J6I",
  authDomain: "manbat-b0919.firebaseapp.com",
  projectId: "manbat-b0919",
  storageBucket: "manbat-b0919.firebasestorage.app",
  messagingSenderId: "286518930930",
  appId: "1:286518930930:web:69cc91accf5ba121864f6b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

var map = L.map('map').setView([24.7, 46.7], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

let selectedLat = null;
let selectedLng = null;
let marker;

// ğŸŒ™ Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
if(localStorage.getItem("mode") === "dark"){
    document.body.classList.add("dark");
    document.getElementById("modeBtn").innerHTML="â˜€ï¸";
}

window.toggleMode = function(){
    document.body.classList.toggle("dark");

    if(document.body.classList.contains("dark")){
        localStorage.setItem("mode","dark");
        document.getElementById("modeBtn").innerHTML="â˜€ï¸";
    }else{
        localStorage.setItem("mode","light");
        document.getElementById("modeBtn").innerHTML="ğŸŒ™";
    }
}

// ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹
map.on('click', function(e){
    selectedLat = e.latlng.lat;
    selectedLng = e.latlng.lng;

    if(marker){
        map.removeLayer(marker);
    }

    marker = L.marker([selectedLat, selectedLng]).addTo(map);
});

// ğŸ™ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªÙØ±Ø¹Ø©
const citiesData = {
    "Ø§Ù„ÙˆØ³Ø·Ù‰":["Ø§Ù„Ø±ÙŠØ§Ø¶","Ø§Ù„Ø®Ø±Ø¬","Ø§Ù„Ù‚ØµÙŠÙ…"],
    "Ø§Ù„ØºØ±Ø¨ÙŠØ©":["Ø¬Ø¯Ø©","Ù…ÙƒØ©","Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"],
    "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©":["Ø§Ù„Ø¯Ù…Ø§Ù…","Ø§Ù„Ø®Ø¨Ø±","Ø§Ù„Ø£Ø­Ø³Ø§Ø¡"],
    "Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©":["Ø£Ø¨Ù‡Ø§","Ù†Ø¬Ø±Ø§Ù†","Ø¬Ø§Ø²Ø§Ù†"],
    "Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©":["ØªØ¨ÙˆÙƒ","Ø¹Ø±Ø¹Ø±","Ø­Ø§Ø¦Ù„"]
};

window.updateCities = function(){
    const region = document.getElementById("region").value;
    const citySelect = document.getElementById("city");
    citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';

    if(citiesData[region]){
        citiesData[region].forEach(c=>{
            citySelect.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }
}

// â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø©
window.submitSchool = async function(){

    const school = document.getElementById("schoolName").value.trim();
    const stage = document.getElementById("stage").value;
    const gender = document.getElementById("gender").value;
    const city = document.getElementById("city").value;

    if(!school || !stage || !gender || !city || selectedLat === null){
        alert("Ø¹Ø¨Ù‘ÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø¯Ø¯ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    }

    await addDoc(collection(db, "schools"), {
        school,stage,gender,city,
        lat:selectedLat,lng:selectedLng,
        time:new Date()
    });

    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© ğŸŒ¿");

    loadSchools();
}

// ğŸ“Š ØªØ­Ù…ÙŠÙ„ + Top 5
async function loadSchools(){

    map.eachLayer(function(layer){
        if(layer instanceof L.Marker){
            map.removeLayer(layer);
        }
    });

    const snapshot = await getDocs(collection(db, "schools"));
    let cityCount = {};

    snapshot.forEach(doc=>{
        const s = doc.data();

        L.marker([s.lat, s.lng])
        .addTo(map)
        .bindPopup(`<b>${s.school}</b><br>${s.city}`);

        cityCount[s.city] = (cityCount[s.city] || 0) + 1;
    });

    // ØªØ±ØªÙŠØ¨ Top 5
    let sorted = Object.entries(cityCount)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5);

    let html = "<b>Top 5 Ø§Ù„Ù…Ø¯Ù†:</b><br>";
    sorted.forEach(c=>{
        html += `${c[0]} (${c[1]})<br>`;
    });

    document.getElementById("top5").innerHTML = html;
}

loadSchools();

</script>
</body>
</html>
