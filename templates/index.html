<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†Ø¨Øª</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
body {
    margin: 0;
    font-family: Tahoma, Arial;
    background: #0f172a;
    color: white;
}

header {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg,#22c55e,#16a34a);
}

header h1 {
    margin: 0;
    font-size: 40px;
}

.container {
    display: grid;
    grid-template-columns: 300px 1fr;
    height: calc(100vh - 100px);
}

.sidebar {
    padding: 15px;
    background: #020617;
    overflow-y: auto;
}

.card {
    background: #020617;
    border: 1px solid #1e293b;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}

button {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    background: #22c55e;
    color: black;
}

input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: none;
}

#map {
    height: 100%;
}
</style>
</head>

<body>

<header>
    <h1>ğŸŒ± Ù…Ù†Ø¨Øª</h1>
    <p>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p>
</header>

<div class="container">
    <div class="sidebar">

        <div class="card">
            <h3>ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø©</h3>
            <input id="schoolName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
            <button onclick="enablePin()">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        </div>

        <div class="card">
            <h3>ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</h3>
            <p id="count">0</p>
        </div>

        <div class="card">
            <h3>ğŸ† Top 5</h3>
            <ol id="top"></ol>
        </div>

        <div class="card">
            <h3>ğŸ” Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£ÙˆÙ†Ø±</h3>
            <button onclick="resetAll()" style="background:#b91c1c;color:white">
                ØªØµÙÙŠØ± Ø§Ù„Ø³ÙŠØ±ÙØ±
            </button>
        </div>

    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map').setView([24.7, 46.7], 6);
let currentMarker = null;
let placing = false;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function deviceId() {
    let id = localStorage.getItem("device_id");
    if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("device_id", id);
    }
    return id;
}

function enablePin() {
    placing = true;
    alert("Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©");
}

map.on("click", e => {
    if (!placing) return;

    let name = document.getElementById("schoolName").value;
    if (!name) {
        alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }

    if (currentMarker) map.removeLayer(currentMarker);

    currentMarker = L.marker(e.latlng).addTo(map);

    fetch("/register", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            school: name,
            lat: e.latlng.lat,
            lng: e.latlng.lng,
            device_id: deviceId()
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) alert(d.error);
        else {
            alert("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
            loadAll();
        }
    });

    placing = false;
});

function loadAll() {
    fetch("/schools")
    .then(r => r.json())
    .then(data => {
        data.forEach(s => {
            L.marker([s.lat, s.lng])
            .addTo(map)
            .bindPopup(`${s.school} (${s.count})`);
        });
    });

    fetch("/schools/top")
    .then(r => r.json())
    .then(data => {
        let t = document.getElementById("top");
        t.innerHTML = "";
        data.forEach(s => {
            t.innerHTML += `<li>${s.school} (${s.count})</li>`;
        });
    });

    fetch("/count")
    .then(r => r.json())
    .then(d => {
        document.getElementById("count").innerText = d.count;
    });
}

function resetAll() {
    let pass = prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£ÙˆÙ†Ø±:");
    if (!pass) return;

    fetch("/admin/reset", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({password: pass})
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) alert("âŒ Ø®Ø·Ø£");
        else {
            alert("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ±");
            location.reload();
        }
    });
}

loadAll();
</script>

</body>
</html>
