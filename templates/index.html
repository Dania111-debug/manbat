<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†Ø¨Øª | Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root {
    --bg: #f6faf7;
    --card: #ffffff;
    --text: #1f2937;
    --green: #2F7D32;
}

body.dark {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #e5e7eb;
}

body {
    font-family: Tahoma, Arial;
    direction: rtl;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 15px;
}

.toggle {
    position: fixed;
    top: 15px;
    left: 15px;
    background: var(--card);
    padding: 8px 12px;
    border-radius: 12px;
    cursor: pointer;
    z-index: 1000;
}

.container {
    max-width: 900px;
    margin: auto;
}

.card {
    background: var(--card);
    padding: 16px;
    border-radius: 16px;
    margin-bottom: 12px;
}

.card input,
.card select,
.card button {
    width: 100%;
    height: 42px;
    border-radius: 12px;
    margin-bottom: 6px;
}

.card input {
    padding: 0 12px;
}

.card button {
    background: var(--green);
    color: white;
    border: none;
    cursor: pointer;
}

#map {
    height: 380px;
    border-radius: 16px;
}

.rank {
    display: flex;
    justify-content: space-between;
    background: rgba(47,125,50,0.12);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 6px;
}
</style>
</head>

<body>

<div class="toggle" onclick="toggleDark()">ğŸŒ™</div>

<div class="container">
<h2>ğŸŒ± Ù…Ù†Ø¨Øª</h2>
<p>Ø®Ø±ÙŠØ·Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</p>

<div class="card">
Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª: <b id="counter">0</b>
</div>

<div class="card">
<h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±ÙƒØ©</h3>

<input id="schoolName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">

<select id="stage">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
<option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
<option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option>
</select>

<select id="gender">
<option value="">Ø¨Ù†ÙŠÙ† / Ø¨Ù†Ø§Øª</option>
<option value="Ø¨Ù†ÙŠÙ†">Ø¨Ù†ÙŠÙ†</option>
<option value="Ø¨Ù†Ø§Øª">Ø¨Ù†Ø§Øª</option>
</select>

<select id="city">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
<option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
<option value="Ø¬Ø¯Ø©">Ø¬Ø¯Ø©</option>
<option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
<option value="Ù…ÙƒØ©">Ù…ÙƒØ©</option>
</select>

<button onclick="submit()">Ø¥Ø¶Ø§ÙØ© ğŸŒ¿</button>
</div>

<div class="card">
<h3>ğŸ† Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</h3>
<div id="topList"></div>
</div>

<div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
function toggleDark(){
    document.body.classList.toggle("dark");
}

let deviceId = localStorage.getItem("device_id");
if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem("device_id", deviceId);
}

var map = L.map('map').setView([24.7, 46.7], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let selected = null;
let tempMarker = null;
let markers = {};

map.on('click', function(e) {
    selected = e.latlng;

    if (tempMarker) {
        map.removeLayer(tempMarker);
    }

    tempMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
});

function loadSchools() {
    fetch('/schools')
    .then(r => r.json())
    .then(data => {
        data.forEach(s => {
            let key = s.school + "-" + s.stage + "-" + s.gender + "-" + s.city;

            if (markers[key]) {
                markers[key]
                    .setPopupContent(`${s.school} - ${s.stage} - ${s.gender} - ${s.city}<br>ğŸ‘©â€ğŸ“ ${s.count}`);
            } else {
                let m = L.marker([s.lat, s.lng])
                    .addTo(map)
                    .bindPopup(`${s.school} - ${s.stage} - ${s.gender} - ${s.city}<br>ğŸ‘©â€ğŸ“ ${s.count}`);
                markers[key] = m;
            }
        });
    });
}

function loadCount(){
    fetch('/count')
    .then(r => r.json())
    .then(d => document.getElementById("counter").innerText = d.count);
}

function loadTop(){
    fetch('/schools/top')
    .then(r => r.json())
    .then(data => {
        let topList = document.getElementById("topList");
        topList.innerHTML = "";
        data.forEach(s => {
            let div = document.createElement("div");
            div.className = "rank";
            div.innerHTML = `<span>${s.school} - ${s.stage} - ${s.gender} - ${s.city}</span><b>${s.count}</b>`;
            topList.appendChild(div);
        });
    });
}

loadSchools();
loadCount();
loadTop();

setInterval(() => {
    loadSchools();
    loadCount();
    loadTop();
}, 5000);

function submit(){
    let school = document.getElementById("schoolName").value.trim();
    let stage = document.getElementById("stage").value;
    let gender = document.getElementById("gender").value;
    let city = document.getElementById("city").value;

    if (!school || !selected || !stage || !gender || !city) {
        alert("Ø¹Ø¨Ù‘ÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø¯Ø¯ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    }

    fetch('/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            school,
            stage,
            gender,
            city,
            lat: selected.lat,
            lng: selected.lng,
            device_id: deviceId
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) alert(d.error);
        else {
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© ğŸŒ¿");
            loadSchools();
            loadCount();
            loadTop();
        }
    });
}
</script>

</body>
</html>
