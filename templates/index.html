<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ù†Ø¨Øª | Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
    font-family: Tahoma;
    direction: rtl;
    margin:0;
    padding:15px;
}
.container{
    max-width:900px;
    margin:auto;
}
.card{
    background:#f4f4f4;
    padding:15px;
    border-radius:15px;
    margin-bottom:10px;
}
.card input,
.card select,
.card button{
    width:100%;
    height:40px;
    margin-bottom:6px;
    border-radius:10px;
}
.card button{
    background:#2F7D32;
    color:white;
    border:none;
    cursor:pointer;
}
#map{
    height:400px;
    border-radius:15px;
}
</style>
</head>

<body>

<div class="container">

<h2>ğŸŒ± Ù…Ù†Ø¨Øª</h2>

<div class="card">

<input id="schoolName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">

<select id="stage">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
<option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
<option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
<option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option>
</select>

<select id="gender">
<option value="">Ø¨Ù†ÙŠÙ† / Ø¨Ù†Ø§Øª</option>
<option value="Ø¨Ù†ÙŠÙ†">Ø¨Ù†ÙŠÙ†</option>
<option value="Ø¨Ù†Ø§Øª">Ø¨Ù†Ø§Øª</option>
</select>

<select id="city">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
<option value="Ø§Ù„Ø±ÙŠØ§Ø¶">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
<option value="Ø¬Ø¯Ø©">Ø¬Ø¯Ø©</option>
<option value="Ù…ÙƒØ©">Ù…ÙƒØ©</option>
<option value="Ø§Ù„Ø¯Ù…Ø§Ù…">Ø§Ù„Ø¯Ù…Ø§Ù…</option>
<option value="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
</select>

<button onclick="submitSchool()">Ø¥Ø¶Ø§ÙØ© ğŸŒ¿</button>

</div>

<div id="map"></div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "manbat-b0919.firebaseapp.com",
  projectId: "manbat-b0919",
  storageBucket: "manbat-b0919.firebasestorage.app",
  messagingSenderId: "286518930930",
  appId: "1:286518930930:web:69cc91accf5ba121864f6b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

var map = L.map('map').setView([24.7, 46.7], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

let selectedLat = null;
let selectedLng = null;
let marker;

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø§Ø±ÙƒØ± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)
map.on('click', function(e){
    selectedLat = e.latlng.lat;
    selectedLng = e.latlng.lng;

    if(marker){
        map.removeLayer(marker);
    }

    marker = L.marker([selectedLat, selectedLng]).addTo(map);
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø©
window.submitSchool = async function(){

    const school = document.getElementById("schoolName").value.trim();
    const stage = document.getElementById("stage").value;
    const gender = document.getElementById("gender").value;
    const city = document.getElementById("city").value;

    if(!school || !stage || !gender || !city || selectedLat === null){
        alert("Ø¹Ø¨Ù‘ÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø¯Ø¯ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    }

    await addDoc(collection(db, "schools"), {
        school,
        stage,
        gender,
        city,
        lat: selectedLat,
        lng: selectedLng,
        time: new Date()
    });

    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© ğŸŒ¿");

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById("schoolName").value = "";
    document.getElementById("stage").value = "";
    document.getElementById("gender").value = "";
    document.getElementById("city").value = "";

    if(marker){
        map.removeLayer(marker);
        marker = null;
    }

    selectedLat = null;
    selectedLng = null;

    loadSchools(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ²
async function loadSchools(){

    map.eachLayer(function(layer){
        if(layer instanceof L.Marker){
            map.removeLayer(layer);
        }
    });

    const querySnapshot = await getDocs(collection(db, "schools"));

    querySnapshot.forEach((doc) => {
        const s = doc.data();

        L.marker([s.lat, s.lng])
        .addTo(map)
        .bindPopup(`
            <b>${s.school}</b><br>
            Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${s.stage}<br>
            Ø§Ù„Ù†ÙˆØ¹: ${s.gender}<br>
            Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${s.city}
        `);
    });
}

loadSchools();

</script>

</body>
</html>
